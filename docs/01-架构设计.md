# 架构设计

## 目标

- 类型安全贯穿前后端
- 低重复的 CRUD 与 Hooks 复用
- 清晰的分层与职责边界
- 可观测（日志/审计）与可运维（OpenAPI）

## 整体分层

```
Client(UI + React Query + Zustand)
        │
        ▼
RPC Client(hono/client + 类型推导)
        │
        ▼
Route(OpenAPI + Zod 校验)
        │
        ▼
Middleware(认证/权限/日志/审计)
        │
        ▼
Service(业务逻辑)
        │
        ▼
Data(Drizzle ORM + MySQL)
```

## 请求处理流程

1. `requestContextMiddleware` 生成 requestId 并写入响应头
2. `contextMiddleware` 将 Hono Context 放入 AsyncLocalStorage（R 工具类依赖）
3. `requestLoggerMiddleware` 记录请求日志
4. `jwtAuth` 解析 token（公开路径跳过）
5. `loadPermissions` 读取权限并缓存
6. 路由 Handler 调用 Service 执行业务
7. 使用 `R` 工具类统一响应，错误由全局处理器捕获

核心顺序见 `src/server/setup/middlewares.ts`。

## 类型安全链路

- **Zod Schema** 是唯一事实来源
- Schema 同时用于：
  - 请求校验
  - OpenAPI 文档
  - TypeScript 类型推导
  - RPC Client 类型约束

```ts
// src/server/routes/admins/dtos.ts
export const CreateAdminInputSchema = z.object({
  username: z.string().min(2).max(50),
  password: z.string().min(6).max(100),
})

export type CreateAdminInput = z.infer<typeof CreateAdminInputSchema>
```

## 工厂化复用

### CRUD 路由定义工厂

```ts
const adminRoutes = createCrudRoutes({
  resourceName: '管理员',
  tag: '用户管理',
  schemas: {
    entity: AdminSchema,
    create: CreateAdminInputSchema,
    update: UpdateAdminInputSchema,
    query: AdminQuerySchema,
    paginated: PaginatedAdminSchema,
  },
})
```

### CRUD 路由实现工厂

```ts
const admins = createCrudRouter({
  moduleName: '用户管理',
  permissionPrefix: 'system:admin',
  routes: adminRoutes,
}, handlers)
```

### React Query Hooks 工厂

```ts
const adminResource = createResource({
  resourceName: 'admins',
  getClient: () => (getApiClient() as any).admins,
})
```

## 应用初始化

```ts
// src/server/app.ts
const app = new OpenAPIHono<Env>()
setupAuditLogger()
setupMiddlewares(app)
setupRoutes(app)
setupOpenAPI(app)
setupErrorHandlers(app)
```

## Context 与请求级数据

Hono Context 扩展变量：

```ts
// src/server/context.ts
export interface Variables {
  requestId: string
  admin: AdminPayload | null
  permissions: string[] | null
}
```

AsyncLocalStorage 保证 Service 层能获取 requestId：

```ts
// src/lib/logging/context.ts
export function createRequestContext(requestId?: string): RequestContext {
  return { requestId: requestId ?? generateRequestId(), startTime: Date.now() }
}
```

## 统一响应与错误处理

- 业务响应统一使用 `R` 工具类
- 异常由 `setupErrorHandlers` 捕获并格式化

```ts
return R.ok(data)
return R.created(entity)
return R.success('操作成功')
```

## 路由类型导出

```ts
// src/server/route-defs.ts
export const routes = new OpenAPIHono<Env>()
  .route('/auth', auth)
  .route('/admins', admins)
  .route('/roles', roles)
  .route('/menus', menus)
  .route('/operation-logs', operationLogs)
  .route('/configs', configs)

export type AppType = typeof routes
```
