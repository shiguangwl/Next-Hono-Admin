# 服务端分层设计

## 路由层（Routes）

目录结构：

```
src/server/routes/{resource}/
├── dtos.ts   # Zod Schema + 类型
├── defs.ts   # OpenAPI 路由定义
└── index.ts  # 路由实现与挂载
```

### CRUD 路由定义工厂

`createCrudRoutes` 统一 CRUD 的 OpenAPI Schema 与响应结构：

```ts
const routes = createCrudRoutes({
  resourceName: '管理员',
  tag: '用户管理',
  schemas: {
    entity: AdminSchema,
    create: CreateAdminInputSchema,
    update: UpdateAdminInputSchema,
    query: AdminQuerySchema,
    paginated: PaginatedAdminSchema,
  },
})
```

### CRUD 路由实现工厂

`createCrudRouter` 统一权限校验、审计日志与响应结构：

```ts
const router = createCrudRouter({
  moduleName: '用户管理',
  permissionPrefix: 'system:admin',
  routes,
}, handlers)
```

默认权限命名：

- `:list` 列表
- `:query` 详情（注意：实际使用 query 而不是 detail）
- `:create` / `:update` / `:delete`

扩展权限示例：

- `system:admin:resetPwd`
- `system:admin:assignRole`
- `system:role:assignMenu`

### 路由实现示例

```ts
// src/server/routes/admins/index.ts
const admins = createCrudRouter({ moduleName: '用户管理', permissionPrefix: 'system:admin', routes: adminRoutes }, {
  list: (q) => getAdminList(q),
  detail: (id) => getAdminById(id),
  create: (input) => createAdmin(input),
  update: (id, input) => updateAdmin(id, input),
  delete: (id, c) => deleteAdmin(id, c.get('admin')!.adminId),
})
```

### 扩展路由（非 CRUD）

示例：重置密码、分配角色等功能建议放在路由模块内扩展：

```ts
admins.use(
  resetPasswordRoute.path,
  requirePermission('system:admin:resetPwd'),
  auditLog({ module: '用户管理', operation: '重置密码', description: '重置管理员密码' })
)
```

## 中间件层（Middleware）

实际注册顺序（`src/server/setup/middlewares.ts`）：

1. `requestContextMiddleware`（生成 requestId）
2. `contextMiddleware`（存储 Hono Context，供 R 工具类使用）
3. `requestLoggerMiddleware`（结构化请求日志）
4. `jwtAuth`（公开路径跳过认证）
5. `loadPermissions`（加载权限，带缓存）

可选中间件：

- `corsMiddleware`（目前注释）
- `apiRateLimit`（全局限流，默认未启用）
- `loginRateLimit`（登录接口限流，在 auth 路由内调用）

### JWT 认证

```ts
// src/server/middleware/jwt-auth.ts
export const jwtAuth = createMiddleware<Env>(async (c, next) => {
  const authHeader = c.req.header('Authorization')
  if (!authHeader?.startsWith('Bearer ')) { c.set('admin', null); return next() }
  const payload = verifyToken(authHeader.slice(7))
  c.set('admin', payload ?? null)
  return next()
})
```

### RBAC 权限

- `loadPermissions` 会缓存权限（`getCachedPermissions`）
- 超级管理员权限为 `['*']`

```ts
// src/server/middleware/rbac.ts
export function requirePermission(permission: string) { /* ... */ }
export function requireAnyPermission(permissions: string[]) { /* ... */ }
export function requireAllPermissions(permissions: string[]) { /* ... */ }
```

## Service 层

- 仅处理业务逻辑与数据访问
- 通过 `AppError` 体系抛出业务错误
- 数据库错误统一走 `handleDatabaseError`

```ts
// src/server/services/system/auth/auth.service.ts
export async function login(input: LoginInput): Promise<LoginResultVo> {
  const admin = await findAdminByUsername(input.username)
  if (!admin) throw new UnauthorizedError('用户名或密码错误')
  // ...省略
}
```

## 响应层

统一使用 `R` 工具类构造响应：

```ts
return R.ok(data)
return R.created(entity)
return R.success('操作成功')
```

注意：`R` 依赖 `contextMiddleware`，否则会抛出 Context not found。
