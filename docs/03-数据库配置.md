# 数据库配置

## Drizzle 配置

```ts
// drizzle.config.ts
export default defineConfig({
  schema: './src/db/schema/index.ts',
  out: './drizzle',
  dialect: 'mysql',
  dbCredentials: { url: process.env.DATABASE_URL! },
  verbose: true,
  strict: true,
})
```

- `schema` 为 Schema 入口
- `out` 为迁移输出目录
- Docker 运行时会复制 `drizzle/` 目录（支持自动迁移）

## 数据库连接与初始化

```ts
// src/db/index.ts（节选）
const pool = mysql.createPool({
  uri: env.DATABASE_URL,
  connectionLimit: env.DATABASE_MAX_CONNECTIONS,
  idleTimeout: env.DATABASE_IDLE_TIMEOUT * 1000,
  connectTimeout: env.DATABASE_CONNECT_TIMEOUT * 1000,
  enableKeepAlive: true,
  keepAliveInitialDelay: 10000,
  timezone: 'local',
})

export const db = drizzle({ client: pool, schema, mode: 'default' })

export async function ensureDatabaseInitialized() {
  if (!env.AUTO_DB_MIGRATE && !env.AUTO_DB_SEED) return
  if (globalThis.__dbInitialized) return
  if (env.AUTO_DB_MIGRATE) await runMigration()
  if (env.AUTO_DB_SEED) await runSeed(db)
}
```

要点：

- HMR 环境使用全局单例，避免重复创建连接池
- `AUTO_DB_MIGRATE` / `AUTO_DB_SEED` 控制启动时自动迁移和种子
- `ensureDatabaseInitialized` 在 `src/instrumentation.ts` 中调用

## Schema 设计要点

### 管理员表（sys_admin）

- `id` 使用 `bigint`
- `username` 唯一索引
- `status` 0/1

### 菜单权限表（sys_menu）

- `menuType`: `D` 目录 / `M` 菜单 / `B` 按钮
- `permission` 唯一索引

### 操作日志表（sys_operation_log）

- `status` 0/1
- 记录请求/响应元数据与耗时

对应实现位置：

- `src/db/schema/admin.ts`
- `src/db/schema/menu.ts`
- `src/db/schema/operation-log.ts`

## 自定义类型：localDatetime

解决 MySQL `DATETIME` 在非 UTC 环境下的时间偏移问题。

```ts
// src/db/custom-types/local-datetime.ts
export const localDatetime = customType({
  dataType() { return 'datetime' },
  toDriver(value: Date) { return formatToLocalDatetimeString(value) },
  fromDriver(value: string) { return new Date(value.replace(' ', 'T')) },
})
```

## 开发常用流程

```bash
# 生成迁移文件
pnpm db:generate

# 推送 Schema 变更（开发）
pnpm db:push

# 执行迁移（生产）
pnpm db:migrate

# 种子数据
pnpm db:seed
```

## 种子数据

- CLI 入口：`src/db/seed.ts`
- 默认创建 `admin / admin123`
