# 认证与权限

## JWT 认证

### Token 工具

```ts
// src/lib/auth/jwt.ts
export function signToken(payload: AdminPayload): string {
  return jwt.sign(payload, env.JWT_SECRET, { expiresIn: env.JWT_EXPIRES_IN as StringValue })
}

export function verifyToken(token: string): AdminPayload | null {
  try { return jwt.verify(token, env.JWT_SECRET) as AdminPayload } catch { return null }
}
```

### 认证接口

- `POST /api/auth/login` 登录（限流）
- `POST /api/auth/logout` 登出（前端清理 Token）
- `GET /api/auth/info` 获取当前管理员信息

实现位置：`src/server/routes/auth`。

### 登录流程（核心步骤）

1. 查询管理员
2. 校验密码
3. 检查账号状态
4. 更新登录信息（IP/时间）
5. 生成 JWT
6. 返回权限列表与菜单树

服务实现：`src/server/services/system/auth/auth.service.ts`

### 登录限流

`loginRateLimit` 在 login 路由中手动触发：

```ts
// src/server/routes/auth/index.ts
await loginRateLimit(c, async () => {})
```

## RBAC 权限模型

```
Admin ── N:M ── Role ── N:M ── Menu(permission)
```

- 菜单类型：`D` 目录 / `M` 菜单 / `B` 按钮
- 超级管理员：`SUPER_ADMIN_ID`，权限自动包含 `'*'`

### 权限标识规范

```
模块:资源:操作
system:admin:list
system:admin:query
system:admin:create
system:admin:update
system:admin:delete
system:admin:resetPwd
system:admin:assignRole
system:role:assignMenu
system:log:list
system:log:query
system:log:delete
```

### 获取权限与菜单树

- `getAdminPermissions` 返回权限列表（超级管理员含 `'*'`）
- `getAdminMenuTree` 仅返回 `D/M` 类型菜单

实现位置：`src/server/services/system/auth/auth.service.ts`

## 认证中间件

```ts
// src/server/middleware/jwt-auth.ts
export const jwtAuth = createMiddleware<Env>(async (c, next) => {
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  c.set('admin', token ? verifyToken(token) : null)
  return next()
})

export const requireAuth = createMiddleware<Env>(async (c, next) => {
  if (!c.get('admin')) throw new UnauthorizedError()
  return next()
})
```

### 公开路径

公开路径由 `src/server/config/public-paths.ts` 控制，目前包含：

- `/api/auth/login`
- `/api/auth/refresh`（预留，当前未实现）

## 权限中间件

```ts
// src/server/middleware/rbac.ts
export const loadPermissions = createLoadPermissions(getAdminPermissions)
export function requirePermission(permission: string) { /* ... */ }
export function requireAnyPermission(permissions: string[]) { /* ... */ }
export function requireAllPermissions(permissions: string[]) { /* ... */ }
```

## 客户端认证状态

- 使用 Zustand 持久化：`auth-storage`
- 初始化时调用 `/api/auth/info` 刷新状态

实现位置：`src/hooks/use-auth.ts`
