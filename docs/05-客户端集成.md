# 客户端集成

## Hono RPC Client

```ts
// src/lib/client/index.ts
export function createClient(options?: ClientOptions): HonoClient {
  const baseUrl = getBaseUrl() // SSR: 绝对地址；CSR: 相对路径
  const token = resolveToken(options?.token)
  return hc<AppType>(`${baseUrl}/api`, { headers: () => createHeaders(token) })
}

export function getApiClient(): HonoClient {
  return createClient()
}
```

### SSR Base URL 规则

- 浏览器：使用相对路径（`''`）
- 服务端：优先 `VERCEL_URL` / `RAILWAY_PUBLIC_DOMAIN`
- 默认回退：`http://localhost:3000`

### Token 解析规则

- `undefined`：自动读取本地 `auth-storage`
- `string`：使用传入 token
- `null`：不携带 token（公开接口/SSR）

## 响应解包

```ts
// src/lib/client/index.ts
export async function unwrapApiData<T>(response, fallbackMessage): Promise<T> {
  const payload = await response.json().catch(() => null)
  if (!response.ok) throw new Error(isRecord(payload) ? payload.message : fallbackMessage)
  if (!isRecord(payload) || !('data' in payload)) throw new Error(fallbackMessage)
  return (payload as ApiSuccessResponse<T>).data
}
```

## React Query 集成

### CRUD Hooks 工厂

```ts
// src/hooks/queries/core/create-resource.ts
const adminResource = createResource({
  resourceName: 'admins',
  getClient: () => (getApiClient() as any).admins,
})
```

生成的 Hooks：

- `useList` / `useDetail`
- `useCreate` / `useUpdate` / `useDelete`

### 典型资源示例

```ts
// src/hooks/queries/admins.ts
export const useAdmins = adminResource.useList
export const useAdmin = adminResource.useDetail
export const useCreateAdmin = adminResource.useCreate
```

## 类型约束说明

`OpenAPIHono` 与 `hono/client` 的类型推导不完全兼容，项目采用“资源级手动定义 Client”方式：

```ts
// src/hooks/queries/admins.ts
type AdminsClient = {
  $get: (args: { query: Record<string, string> }) => Promise<ClientResponse<unknown>>
  $post: (args: { json: CreateAdminInput }) => Promise<ClientResponse<unknown>>
  ':id': { /* ... */ }
}
```

这样既保证类型安全，也避免全局类型污染。
