# 错误处理

## 错误类型体系

`src/lib/errors/types.ts` 定义统一的错误基类与业务错误：

- `AppError`：包含 `code` / `httpStatus` / `details` / `isOperational`
- `UnauthorizedError` / `ForbiddenError` / `NotFoundError`
- `ConflictError` / `ValidationError` / `BusinessError`
- `RateLimitError` / `InternalServerError` / `DatabaseError`

错误码集中在 `src/lib/errors/codes.ts`，前端可据此精确处理。

## 全局错误处理

```ts
// src/server/setup/error-handlers.ts
app.onError((err, c) => {
  if (err instanceof HTTPException) {
    return c.json({ code: 'HTTP_ERROR', message: safeMessage, requestId }, err.status)
  }
  const errorResponse = mapErrorToResponse(err, requestId)
  return c.json({
    code: errorResponse.code,
    message: errorResponse.message,
    details: errorResponse.details,
    requestId: errorResponse.requestId,
  }, errorResponse.status)
})
```

### mapErrorToResponse 行为

- 操作性错误（4xx）记录 warn
- 非操作性错误（5xx）记录 error + 监控
- 生产环境隐藏 `details`

### 错误响应结构

```json
{
  "code": "VALIDATION_ERROR",
  "message": "请求参数验证失败",
  "details": [],
  "requestId": "..."
}
```

## 数据库错误转换

```ts
// src/lib/errors/database.ts
export function handleDatabaseError(err: unknown): AppError { /* ... */ }
```

使用方式：

```ts
try {
  await db.insert(sysAdmin).values(data)
} catch (err) {
  throw handleDatabaseError(err)
}
```

## 业务成功响应

项目内统一使用 `R` 工具类，返回业务层状态码：

```ts
return R.ok(data)
return R.created(entity)
return R.success('操作成功')
```

## 404 处理

```ts
app.notFound((c) => c.json({ code: 'NOT_FOUND', message: `Route ... not found`, requestId }, 404))
```
