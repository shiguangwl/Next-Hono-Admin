# 日志系统

## 请求级日志上下文

使用 AsyncLocalStorage 保存 requestId，确保在 Service 层也能读取。

```ts
// src/lib/logging/context.ts
export function createRequestContext(requestId?: string): RequestContext {
  return { requestId: requestId ?? generateRequestId(), startTime: Date.now() }
}
```

```ts
// src/server/middleware/request-context.ts
export const requestContextMiddleware = createMiddleware<Env>(async (c, next) => {
  const requestId = c.req.header('x-request-id') ?? crypto.randomUUID()
  c.set('requestId', requestId)
  c.header('x-request-id', requestId)
  return runWithRequestContext(createRequestContext(requestId), next)
})
```

客户端可自定义 `x-request-id`，否则服务端自动生成。

## 结构化日志（Pino）

```ts
// src/lib/logging/logger.ts
export const logger = {
  info(msg, meta) { getContextualLogger().info(meta ?? {}, msg) },
  warn(msg, meta) { getContextualLogger().warn(meta ?? {}, msg) },
  error(msg, meta) { getContextualLogger().error(meta ?? {}, msg) },
}
```

- 开发环境默认 debug
- 生产环境默认 info
- 请求级日志自动附带 `requestId`

## 请求日志中间件

```ts
// src/server/middleware/request-logger.ts
export const requestLoggerMiddleware = createMiddleware<Env>(async (c, next) => {
  const start = Date.now()
  await next()
  const duration = Date.now() - start
  const status = c.res.status
  const admin = c.get('admin')
  const message = `${c.req.method} ${c.req.path} → ${status} ${duration}ms`
  status >= 500 ? logger.error(message) : status >= 400 ? logger.warn(message) : logger.info(message)
})
```

- GET/DELETE 会记录查询参数
- 仅错误时记录客户端 IP

## 审计日志

### 审计中间件

```ts
// src/server/middleware/audit-log.ts
export function auditLog(options: AuditOptions) {
  return createMiddleware<Env>(async (c, next) => {
    // 读取请求参数（GET/DELETE 取 query，POST/PUT 取 body）
    // 敏感字段会被脱敏
    // 执行后写入审计日志
  })
}
```

### 记录器配置

```ts
// src/server/setup/audit.ts
export function setupAuditLogger() {
  setLogRecorder(async (data) => {
    await createOperationLog({ ...data })
  })
}
```

审计日志字段来自 `sys_operation_log`，实现位于：

- `src/server/services/system/audit`
- `src/db/schema/operation-log.ts`
