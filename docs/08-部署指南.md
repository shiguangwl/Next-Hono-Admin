# 部署指南

## Docker 部署

### Dockerfile 关键点

- 基于 `node:23-alpine`
- pnpm 构建
- `.next/standalone` 运行
- 复制 `drizzle/` 以支持自动迁移
- 安装并设置时区 `Asia/Shanghai`

实际文件：`Dockerfile`

### docker-compose

```yaml
services:
  app:
    image: ${IMAGE_NAME:-panel_service}:${IMAGE_TAG:-latest}
    ports:
      - "${APP_PORT:-3000}:3000"
    env_file:
      - .env.production
    environment:
      - TZ=Asia/Shanghai
```

### 构建与运行

```bash
docker build -t nextadminhono:latest .

docker compose up -d

docker compose logs -f app
```

## 环境变量

必须配置（`src/env.ts`）：

- `DATABASE_URL`
- `DATABASE_MAX_CONNECTIONS`
- `DATABASE_IDLE_TIMEOUT`
- `DATABASE_CONNECT_TIMEOUT`
- `AUTO_DB_MIGRATE`
- `AUTO_DB_SEED`
- `JWT_SECRET`
- `JWT_EXPIRES_IN`
- `NODE_ENV`

建议：

- `.env.production` 作为模板
- `.env.production.local` 作为真实密钥（不提交）

## 自动迁移与种子

- `AUTO_DB_MIGRATE=true` 会在应用启动时自动执行迁移
- `AUTO_DB_SEED=true` 会在应用启动时自动执行种子
- 生产环境建议谨慎开启，避免误操作

## 应用初始化

`src/instrumentation.ts` 在 Node 运行时执行：

- 数据库自动初始化（可选）
- 错误监控初始化（开发环境默认 ConsoleMonitor）

## OpenAPI

- JSON: `/api/doc`
- Swagger UI: `/api/swagger`
