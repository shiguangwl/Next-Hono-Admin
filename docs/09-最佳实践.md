# 最佳实践

本项目已形成一套可复用的工程范式。以下内容基于当前实现总结，目的是让新模块接入时“有章可循、不会走偏”。

## 1. 总体原则

- **类型优先**：以 Zod Schema 作为唯一事实来源
- **层次清晰**：路由只做校验与编排，业务逻辑放在 Service
- **少而统一**：CRUD/Hook 工厂优先，避免重复逻辑
- **可观测**：请求级日志 + 审计日志默认开启
- **安全默认**：输入必校验、权限必校验、敏感信息不落日志

## 2. 路由设计

### 2.1 路由结构

每个资源建议遵循以下结构：

```
src/server/routes/{resource}/
├── dtos.ts   # Zod Schema + 类型
├── defs.ts   # OpenAPI 路由定义
└── index.ts  # 路由实现与挂载
```

### 2.2 CRUD 优先工厂化

- **路由定义**：`createCrudRoutes`
- **路由实现**：`createCrudRouter`

```ts
// defs.ts
const roleRoutes = createCrudRoutes({
  resourceName: '角色',
  tag: '角色管理',
  schemas: { entity, create, update, query, paginated },
})

// index.ts
const roles = createCrudRouter({
  moduleName: '角色管理',
  permissionPrefix: 'system:role',
  routes: roleRoutes,
}, handlers)
```

### 2.3 权限命名规范

CRUD 权限默认：

- `:list` 列表
- `:query` 详情
- `:create` / `:update` / `:delete`

示例：

```
system:admin:list
system:admin:query
system:admin:create
system:admin:update
system:admin:delete
```

扩展权限应使用明确语义：

- `system:admin:resetPwd`
- `system:admin:assignRole`
- `system:role:assignMenu`
- `system:log:delete`

### 2.4 扩展路由的写法

```ts
admins.use(
  resetPasswordRoute.path,
  requirePermission('system:admin:resetPwd'),
  auditLog({ module: '用户管理', operation: '重置密码', description: '重置管理员密码' })
)
```

## 3. 中间件与请求流程

中间件注册顺序严格固定（`src/server/setup/middlewares.ts`）：

1. `requestContextMiddleware` 生成 requestId
2. `contextMiddleware` 写入 AsyncLocalStorage（R 工具类依赖）
3. `requestLoggerMiddleware` 记录请求日志
4. `jwtAuth` 解析 token（公开路径跳过）
5. `loadPermissions` 加载权限（带缓存）

**不要随意调整顺序**，否则会导致 requestId 丢失或权限未加载。

## 4. 认证与权限

### 4.1 登录流程规范

登录流程必须保证：

1. 校验用户名/密码
2. 判断账号状态
3. 更新登录信息（IP/时间）
4. 生成 JWT
5. 返回权限列表与菜单树

### 4.2 登录限流

登录接口手动触发限流：

```ts
await loginRateLimit(c, async () => {})
```

### 4.3 公开路径

由 `src/server/config/public-paths.ts` 统一维护，避免散落在各处。

## 5. 错误处理

### 5.1 错误类型与错误码

- 基类：`AppError`
- 业务错误：`UnauthorizedError` / `ForbiddenError` / `NotFoundError` / `BusinessError`
- 系统错误：`InternalServerError` / `DatabaseError`

错误码集中在 `src/lib/errors/codes.ts`，前端可直接根据 code 做提示与分流。

### 5.2 数据库错误转换

```ts
try {
  await db.insert(sysAdmin).values(data)
} catch (err) {
  throw handleDatabaseError(err)
}
```

### 5.3 统一响应

新路由建议统一使用 `R` 工具类：

```ts
return R.ok(data)
return R.created(entity)
return R.success('操作成功')
```

注意：`R` 依赖 `contextMiddleware`，否则会抛出 Context not found。

## 6. 数据库与 Schema

### 6.1 Schema 规范

- 所有表使用 `bigint` 作为主键
- 状态字段统一 `tinyint`（0/1）
- 时间字段统一 `localDatetime`

### 6.2 localDatetime 的使用

```ts
createdAt: localDatetime('created_at')
  .notNull()
  .default(sql`CURRENT_TIMESTAMP`)
```

### 6.3 分页查询

```ts
const offset = (page - 1) * pageSize
const list = await db.select().from(table).limit(pageSize).offset(offset)
```

## 7. 日志与审计

### 7.1 请求日志

- 请求级 `requestId` 自动注入
- 仅在错误时记录 IP

### 7.2 审计日志

- 对写操作（create/update/delete）默认开启
- 审计日志写入异步，不阻塞请求
- 请求体会做敏感字段脱敏

## 8. 客户端与 Hooks

### 8.1 RPC Client

- SSR 使用绝对地址
- CSR 使用相对路径
- token 默认从 `auth-storage` 读取

### 8.2 Hooks 工厂

`createResource` 统一了 CRUD Hooks，避免重复逻辑。

```ts
const adminResource = createResource({
  resourceName: 'admins',
  getClient: () => (getApiClient() as any).admins,
})
```

## 9. 前端开发规范

- 页面统一 `PageContainer + PageHeader`
- 搜索区使用 Card 分块
- 表格使用 `DataTable` + `Pagination`
- 权限按钮必须包裹 `PermissionGuard`

## 10. 安全实践

- 所有输入必须通过 Zod 校验
- 禁止拼接 SQL
- JWT_SECRET 必须 ≥ 32 字符
- 日志中禁止输出明文密码/Token

## 11. 部署与运维

- Dockerfile 已配置 `.next/standalone`
- 生产环境变量建议写在 `.env.production.local`
- `AUTO_DB_MIGRATE/AUTO_DB_SEED` 生产环境慎用

## 12. 推荐检查清单（上线前）

- OpenAPI `/api/doc` 可访问
- Swagger UI `/api/swagger` 可访问
- 登录/权限校验正常
- 审计日志写入正常
- 错误码与前端提示匹配
